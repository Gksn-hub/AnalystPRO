<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnalystPro — Meeting Setup</title>
  <style>
    body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}
    .card{max-width:680px;margin:0 auto;border:1px solid #e5e7eb;border-radius:12px;padding:20px;background:#fff}
    h1{margin:0 0 12px}.muted{color:#6b7280}
    .log{font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#374151;margin-top:8px;white-space:pre-wrap}
  </style>

  <!-- Teams JS v2 (defer so it doesn’t block) -->
  <script defer src="https://res.cdn.office.net/teams-js/v2.21.0/js/MicrosoftTeams.min.js"></script>

  <!-- Fallback loader for v1 if v2 isn't available soon -->
  <script>
    // If v2 script fails entirely, try v1
    window.addEventListener('error', function(){
      if (!window.microsoftTeams) {
        var s=document.createElement('script');
        s.src="https://res.cdn.office.net/teams-js/1.12.0/js/MicrosoftTeams.min.js";
        s.defer=true;
        document.head.appendChild(s);
      }
    }, { once:true });

    // Small helper logger
    function log(msg){
      var el = document.getElementById('log');
      if (el) { el.textContent += (el.textContent ? '\n' : '') + msg; }
      console.log(msg);
    }

    // Wait/poll for microsoftTeams to exist (handles slow loads)
    async function waitForTeamsSDK(timeoutMs=8000){
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        if (window.microsoftTeams && (microsoftTeams.app || microsoftTeams.initialize)) return true;
        await new Promise(r=>setTimeout(r,150));
      }
      return false;
    }

    async function init(){
      log('Waiting for Teams SDK…');
      const ok = await waitForTeamsSDK();
      if (!ok){
        log('Could not load Teams SDK. Please try again.');
        return;
      }

      try {
        // v2 init if available, else v1
        if (microsoftTeams.app && microsoftTeams.app.initialize){
          await microsoftTeams.app.initialize();
          log('Initialized (v2).');
          microsoftTeams.pages.config.setValidityState(true);
          log('Validity set (v2).');
          microsoftTeams.pages.config.registerOnSaveHandler(async (saveEvent) => {
            try {
              await microsoftTeams.pages.config.setConfig({
                entityId: "analystProMeeting",
                contentUrl: "https://gksn-hub.github.io/AnalystPRO/index.html",
                websiteUrl: "https://gksn-hub.github.io/AnalystPRO",
                suggestedDisplayName: "AnalystPro"
              });
              log('Config set (v2).');
              saveEvent.notifySuccess();
            } catch(e){
              log('setConfig failed (v2): ' + (e?.message || e));
              saveEvent.notifyFailure(e?.message || 'setConfig failed');
            }
          });
        } else if (microsoftTeams.initialize){ // v1 API shape
          microsoftTeams.initialize();
          log('Initialized (v1).');
          if (microsoftTeams.settings && microsoftTeams.settings.setValidityState){
            microsoftTeams.settings.setValidityState(true);
          }
          // v1 uses settings.registerOnSaveHandler & setSettings
          if (microsoftTeams.settings && microsoftTeams.settings.registerOnSaveHandler){
            microsoftTeams.settings.registerOnSaveHandler(function(saveEvent){
              try {
                microsoftTeams.settings.setSettings({
                  entityId: "analystProMeeting",
                  contentUrl: "https://gksn-hub.github.io/AnalystPRO/index.html",
                  websiteUrl: "https://gksn-hub.github.io/AnalystPRO",
                  suggestedDisplayName: "AnalystPro"
                });
                log('Config set (v1).');
                saveEvent.notifySuccess();
              } catch(e){
                log('setSettings failed (v1): ' + (e?.message || e));
                saveEvent.notifyFailure(e?.message || 'setSettings failed');
              }
            });
          }
        }
        // Re-affirm validity after 1s (defensive)
        setTimeout(()=> {
          try {
            if (microsoftTeams.pages?.config?.setValidityState) {
              microsoftTeams.pages.config.setValidityState(true);
            } else if (microsoftTeams.settings?.setValidityState) {
              microsoftTeams.settings.setValidityState(true);
            }
          } catch {}
        }, 1000);

      } catch(e){
        log('Teams init error: ' + (e?.message || e));
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="card">
    <h1>AnalystPro</h1>
    <p class="muted">Click <b>Save</b> to add AnalystPro to this meeting. You can open it from the side panel during the call.</p>
    <div id="log" class="log"></div>
  </div>
</body>
</html>
